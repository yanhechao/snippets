(function($) {
    $.fn.remoteChained = function(parent_selector, url, options) {
        return this.each(function() {
            var self = this;
            var backup = $(self).clone();
            var multipluflag = false;
            if($(this).attr("multiple")=="multiple")
            	multipluflag=true;
            $(parent_selector).each(function() {
                $(this).bind("change",
                function() {
                    var data = {};
                    var isUndefined = false;
                    $(parent_selector).each(function() {
                        var id = $(this).attr("id");
                        var value = encodeURIComponent($(":selected", this).val());
                        data[id] = value;
                        data[id] = value;
                    	isUndefined = value=="undefined";
                    });
                    if(options) {
                    	data['selectedId'] = options;
                    }
                    if(!isUndefined) {
                    $.getJSON(url, data,
                    function(json) {
                        $("option", self).remove();
                        for (var key in json) {
                            if (!json.hasOwnProperty(key)) {
                                continue
                            }
                            if ("selected" == key) {
                                continue
                            }
                            var option = $("<option />").val(key).append(json[key]);
                            if(key==''){
                            	$(self).prepend(option);
                            }else{
                            	$(self).append(option);
                            }
                            
                        }
                        var selectedStr = json["selected"];
                        var selectedArr = new Array();
                        if(multipluflag){
                        	selectedArr = selectedStr.split(",");
                        }
                        $(self).children().each(function() {
                        	if(!multipluflag){
                        		if ($(this).val() == selectedStr) {
                                    $(this).attr("selected", "selected")
                                }
                        	}else{
                    			if ($.inArray($(this).val(),selectedArr)!=-1) {
                                    $(this).attr("selected", "selected")
                                }
                        	}
                        });
                        /*
                        if (1 == $("option", self).size() && $(self).val() === "") {
                            $(self).attr("disabled", "disabled")
                        } else {
                            $(self).removeAttr("disabled")
                        }*/
                        $(self).trigger("change")
                    })
                    }
                });
                $(this).trigger("change")
            })
        })
    };
    $.fn.remoteChainedTo = $.fn.remoteChained
})(jQuery);